name: Tests

on:
  pull_request:
  workflow_run:
    workflows: ['AutoPR']
    types:
      - completed

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

    - name: Test
      run: go test -v ./tests/golearn_test.go
    # We must set the commit status manually
    # Reference: https://github.com/bahmutov/eleventy-example/blob/main/.github/workflows/ci.yml#L27
    - name: Staging Tests âœ…
      if: ${{ success() }}
      # set the merge commit status check
      # using GitHub REST API
      # see https://docs.github.com/en/rest/reference/repos#create-a-commit-status
      run: |
        curl --request POST \
        --url https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
        --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
        --header 'content-type: application/json' \
        --data '{
          "context": "test",
          "state": "success",
          "description": "Tests passed",
          "target_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        }'
    - name: Staging Tests ðŸš¨
      if: ${{ failure() }}
      # set the merge commit status check
      # using GitHub REST API
      # see https://docs.github.com/en/rest/reference/repos#create-a-commit-status
      run: |
        curl --request POST \
        --url https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
        --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
        --header 'content-type: application/json' \
        --data '{
          "context": "test",
          "state": "failure",
          "description": "Tests failed",
          "target_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        }'